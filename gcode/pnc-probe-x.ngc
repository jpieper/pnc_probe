o<pnc-probe-x> SUB

( Probe along the X direction for the Pocket NC )
( )
( This script probes along the X direction, first at a fast speed )
( then repeating the same value at a slower speed. )
( )
( The coordinate system can either be inches or metric, the result is )
( reported in the current unit system.)
( )
( The resulting probed coordinate is returned from the routine in the )
( current coordinate system. )

( Parameters )
(
(  1: axis 1 for X, 2 for Y )
(  2: direction, either +1 or -1 )
(  3: maximum movement distance )

#<axis] = [#1]
#<direction = [#2]
#<max_probe> = [#3]


(--------------------- CONFIG ----------------------)
#<retract_mm> = 2
#<probe_feed1_mm_min> = 500
#<probe_feed2_mm_min> = 50


(--------- convert constants into current unit system ---------)

o90 IF [#<_metric> EQ 1]
#<retract> = #<retract_mm>
#<probe_feed1> = #<probe_feed1_mm_min>
#<probe_feed2> = #<probe_feed2_mm_min>
o90 ELSE
#<retract> = #<retract_mm> / 25.4
#<probe_feed1> = #<probe_feed1_mm_min> / 25.4
#<probe_feed2> = #<probe_feed2_mm_min> / 25.4
o90 ENDIF

(--------- start of actual routine -----------)

M70  ( save current modal state )

M5                    ( make sure spindle is off )
G40                   ( disable cutter compensation )
G94                   ( feedrate in units /min )

#<start_x> = [#5420]  ( capture the current x position )

G91                   ( use relative positioning )

( trip probe slowly )
o100 IF [#<axis> EQ 1]
G38.2 X[#<direction> * #<max_probe>] F[#<probe_feed1>]
o100 ELSE
G38.2 Y[#<direction> * #<max_probe>] F[#<probe_feed1>]
o100 ENDIF


( retract )
o110 IF [#<axis> EQ 1]
G0 X[-1 * #<direction> * #<retract>]
o110 ELSE
G0 Y[-1 * #<direction> * #<retract>]
o110 ENDIF

( trip probe very slowly )
o120 IF [#<axis> EQ 1]
G38.2 X[#<direction> * #<retract> * 1.25] F[#<probe_feed2>]
o120 ELSE
G38.2 Y[#<direction> * #<retract> * 1.25] F[#<probe_feed2>]
o120 ENDIF

#<trip_point> = [#[5060 + #1]]

( retract again so that we are clear to lift if necessary )
o130 IF [#<axis> EQ 1]
G0 X[-1 * #<direction> * #<retract>]
o130 ELSE
G0 Y[-1 * #<direction> * #<retract>]
o130 ENDIF

M72  ( restore current modal state )

o<pnc-probe-x> ENDSUB #<trip_point>
